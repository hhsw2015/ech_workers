name: Simple Build for ARMv7

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Install ARM compiler
      run: |
        # 安装 ARM 交叉编译器
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf
        
        # 安装 musl 工具
        wget -q https://musl.cc/arm-linux-musleabihf-cross.tgz
        tar -xzf arm-linux-musleabihf-cross.tgz
        echo "$PWD/arm-linux-musleabihf-cross/bin" >> $GITHUB_PATH
    
    - name: Build
      run: |
        # 纯 Go 版本（最简单，无依赖）
        echo "构建纯 Go 版本..."
        GOOS=linux GOARCH=arm GOARM=7 CGO_ENABLED=0 \
          go build -o ech-workers-armv7 \
          -ldflags="-w -s" .
        
        # 尝试静态编译（如果工具链可用）
        if command -v arm-linux-musleabihf-gcc >/dev/null 2>&1; then
          echo "构建 musl 静态版本..."
          CC=arm-linux-musleabihf-gcc \
          GOOS=linux GOARCH=arm GOARM=7 CGO_ENABLED=1 \
            go build -a -o ech-workers-armv7-static \
            -ldflags="-w -s -linkmode external -extldflags '-static'" .
        fi
    
    - name: Verify and package
      run: |
        echo "验证构建结果:"
        ls -lh ech-workers-*
        file ech-workers-*
        
        echo "创建发布包..."
        mkdir -p release
        cp ech-workers-armv7* release/ 2>/dev/null || true
        tar -czf release/ech-workers-armv7.tar.gz -C release .
    
    - uses: actions/upload-artifact@v3
      with:
        name: armv7-binaries
        path: release/
