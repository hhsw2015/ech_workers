name: ğŸ”¨ Build ARMv7 for Hi3798MV100

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]  # æ ‡ç­¾è§¦å‘æ—¶åˆ›å»ºæ­£å¼å‘å¸ƒ
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (å¦‚ v1.0.0)'
        required: false
        default: 'auto'
      clean_build:
        description: 'æ¸…ç†æ„å»ºç¼“å­˜'
        required: false
        default: false

env:
  GO_VERSION: '1.21'
  PROJECT_NAME: 'ech-workers'
  BUILD_TARGET: 'hi3798mv100'
  OUTPUT_DIR: 'artifacts'
  CACHE_KEY: ${{ github.ref }}

jobs:
  build-check:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      build_version: ${{ steps.version.outputs.build_version }}
    
    steps:
      - name: ğŸ” æ£€æŸ¥æ„å»ºæ¡ä»¶
        id: check
        run: |
          # è·³è¿‡æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶çš„å˜æ›´
          if [[ "${{ github.event.head_commit.message }}" =~ ^(docs|chore|style) ]]; then
            echo "::warning::è·³è¿‡æ„å»ºï¼ˆä»…æ–‡æ¡£/é…ç½®å˜æ›´ï¼‰"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ·ï¸ ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "auto" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            DATE=$(date +%Y%m%d)
            COMMIT=${GITHUB_SHA:0:8}
            VERSION="nightly-${DATE}-${COMMIT}"
          fi
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "build_version=$VERSION" >> $GITHUB_OUTPUT

  build-armv7:
    runs-on: ubuntu-latest
    needs: build-check
    if: needs.build-check.outputs.should_build == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        build_type: [standard, static]
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hhsw2015/ech_workers
          fetch-depth: 0
          lfs: true
      
      - name: ğŸ”§ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum
      
      - name: ğŸ“¦ åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          echo "BUILD_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "GO_VERSION=$(go version | cut -d' ' -f3)" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
          echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
          echo "é¡¹ç›®: ${{ env.PROJECT_NAME }}"
          echo "ç›®æ ‡è®¾å¤‡: ${{ env.BUILD_TARGET }}"
          echo "ç‰ˆæœ¬: ${{ needs.build-check.outputs.build_version }}"
          echo "æ„å»ºç±»å‹: ${{ matrix.build_type }}"
          echo "Goç‰ˆæœ¬: $(go version)"
      
      - name: ğŸ› ï¸ æ„å»º ARMv7 ç‰ˆæœ¬
        id: build
        run: |
          set -e
          
          VERSION="${{ needs.build-check.outputs.build_version }}"
          COMMIT=$(git rev-parse --short HEAD)
          
          echo "ğŸš€ å¼€å§‹æ„å»º ${{ matrix.build_type }} ç‰ˆæœ¬..."
          
          # è®¾ç½®æ„å»ºå‚æ•°
          if [ "${{ matrix.build_type }}" = "static" ]; then
            LD_FLAGS="-w -s -extldflags \"-static\""
            OUTPUT_SUFFIX="-static"
            CGO_ENABLED="0"
          else
            LD_FLAGS="-w -s"
            OUTPUT_SUFFIX=""
            CGO_ENABLED="1"
          fi
          
          # è®¾ç½®å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯
          FULL_VERSION="${VERSION}+${COMMIT}"
          
          # äº¤å‰ç¼–è¯‘å‘½ä»¤
          GOOS=linux GOARCH=arm GOARM=7 CGO_ENABLED=$CGO_ENABLED \
            go build \
            -v \
            -trimpath \
            -o "${{ env.OUTPUT_DIR }}/${{ env.PROJECT_NAME }}-armv7${OUTPUT_SUFFIX}" \
            -ldflags="${LD_FLAGS} \
              -X 'main.Version=$FULL_VERSION' \
              -X 'main.BuildTime=${{ env.BUILD_DATE }}' \
              -X 'main.GoVersion=${{ env.GO_VERSION }}' \
              -X 'main.Commit=$COMMIT'" \
            .
          
          echo "âœ… æ„å»ºå®Œæˆ"
          
          # è¾“å‡ºæ„å»ºä¿¡æ¯
          echo "build_output=${{ env.OUTPUT_DIR }}/${{ env.PROJECT_NAME }}-armv7${OUTPUT_SUFFIX}" >> $GITHUB_OUTPUT
          echo "build_suffix=${OUTPUT_SUFFIX}" >> $GITHUB_OUTPUT
      
      - name: ğŸ” éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºç»“æœ:"
          ls -lh ${{ env.OUTPUT_DIR }}/
          
          FILE="${{ steps.build.outputs.build_output }}"
          echo "ğŸ“„ æ–‡ä»¶ä¿¡æ¯:"
          file "$FILE"
          
          echo "ğŸ“¦ æ–‡ä»¶å¤§å°:"
          ls -lh "$FILE"
          
          echo "ğŸ”¢ æ£€æŸ¥ ELF å¤´éƒ¨:"
          readelf -h "$FILE" | grep -E "(æœºå™¨|ç±»å‹|å…¥å£ç‚¹)" || true
      
      - name: ğŸ§ª QEMU æ¨¡æ‹Ÿæµ‹è¯•
        run: |
          echo "ğŸ§ª ä½¿ç”¨ QEMU è¿›è¡ŒåŸºæœ¬æµ‹è¯•..."
          sudo apt-get update
          sudo apt-get install -y qemu-user-static qemu-user
          
          TEST_BIN="${{ steps.build.outputs.build_output }}"
          chmod +x "$TEST_BIN"
          
          echo "æµ‹è¯•å¸®åŠ©å‘½ä»¤:"
          timeout 5s qemu-arm-static "$TEST_BIN" --help 2>&1 | head -20 || \
            echo "âš ï¸ QEMU æµ‹è¯•å¯èƒ½å—é™ï¼Œç»§ç»­æ„å»ºæµç¨‹..."
          
          echo "âœ… QEMU æµ‹è¯•å®Œæˆ"
      
      - name: ğŸ”’ åˆ›å»ºæ ¡éªŒå’Œ
        run: |
          echo "ğŸ”’ ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ..."
          
          BIN_FILE="${{ steps.build.outputs.build_output }}"
          BASE_NAME=$(basename "$BIN_FILE")
          
          cd ${{ env.OUTPUT_DIR }}
          
          # åˆ›å»ºå¤šç§æ ¡éªŒå’Œ
          sha256sum "$BASE_NAME" > "$BASE_NAME.sha256"
          sha1sum "$BASE_NAME" > "$BASE_NAME.sha1"
          md5sum "$BASE_NAME" > "$BASE_NAME.md5"
          
          # åˆ›å»º BLAKE3 æ ¡éªŒå’Œï¼ˆæ›´ç°ä»£ï¼‰
          if command -v b3sum &> /dev/null; then
            sudo apt-get install -y b3sum
            b3sum "$BASE_NAME" > "$BASE_NAME.b3sum"
          fi
          
          echo "ğŸ“‹ æ ¡éªŒå’Œåˆ—è¡¨:"
          cat *.sha256
          cat *.sha1
          cat *.md5
          [ -f *.b3sum ] && cat *.b3sum || true
      
      - name: ğŸ“„ åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        run: |
          echo "ğŸ“ åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯..."
          
          cat > "${{ env.OUTPUT_DIR }}/BUILD_INFO.txt" << EOF
# ${{ env.PROJECT_NAME }} - ${{ env.BUILD_TARGET }} æ„å»ºä¿¡æ¯
æ„å»ºæ—¶é—´: ${{ env.BUILD_DATE }}
ç‰ˆæœ¬: ${{ needs.build-check.outputs.build_version }}
æäº¤: $(git rev-parse HEAD)
åˆ†æ”¯: ${{ github.ref_name }}
æ„å»ºç±»å‹: ${{ matrix.build_type }}

## ç¯å¢ƒä¿¡æ¯
GitHub Actions URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
è§¦å‘äº‹ä»¶: ${{ github.event_name }}
è§¦å‘è€…: ${{ github.actor }}

## æ„å»ºé…ç½®
Go ç‰ˆæœ¬: ${{ env.GO_VERSION }}
æ“ä½œç³»ç»Ÿ: $(uname -s)
æ¶æ„: $(uname -m)
æ„å»ºå‚æ•°: GOOS=linux GOARCH=arm GOARM=7

## æ–‡ä»¶ä¿¡æ¯
äºŒè¿›åˆ¶æ–‡ä»¶: $(basename ${{ steps.build.outputs.build_output }})
æ–‡ä»¶å¤§å°: $(du -h ${{ steps.build.outputs.build_output }} | cut -f1)
ELF ç±»å‹: $(file ${{ steps.build.outputs.build_output }} | cut -d':' -f2-)

## ä¾èµ–ç‰ˆæœ¬
$(go version)
$(go list -m all | grep -E "(ech|workers|cloudflare)" || echo "æ— ç‰¹æ®Šä¾èµ–")
EOF
          
          echo "âœ… ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶å·²åˆ›å»º"
      
      - name: ğŸ“¦ æ‰“åŒ…æ„å»ºç»“æœ
        run: |
          echo "ğŸ“¦ æ‰“åŒ…æ„å»ºç»“æœ..."
          
          VERSION="${{ needs.build-check.outputs.build_version }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          cd ${{ env.OUTPUT_DIR }}
          
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          PACKAGE_DIR="${{ env.PROJECT_NAME }}-${VERSION}-armv7-${BUILD_TYPE}"
          mkdir -p "$PACKAGE_DIR"
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
          cp ${{ env.PROJECT_NAME }}-armv7${steps.build.outputs.build_suffix}* "$PACKAGE_DIR/"
          cp BUILD_INFO.txt "$PACKAGE_DIR/"
          
          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > "$PACKAGE_DIR/install.sh" << 'EOF'
#!/bin/bash
# ech-workers Hi3798MV100 ARMv7 å®‰è£…è„šæœ¬
# ç‰ˆæœ¬: ${{ needs.build-check.outputs.build_version }}

set -e

# é…ç½®å‚æ•°
INSTALL_DIR="/usr/local/bin"
SERVICE_DIR="/etc/systemd/system"
CONFIG_DIR="/etc/ech-workers"
LOG_DIR="/var/log/ech-workers"
TEMP_DIR="/tmp/ech-workers-install"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

warn() {
    echo -e "${YELLOW}âš ${NC} $1"
}

error() {
    echo -e "${RED}âœ—${NC} $1"
    exit 1
}

# æ˜¾ç¤ºæ¨ªå¹…
show_banner() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         ech-workers Hi3798MV100 ARMv7 å®‰è£…ç¨‹åº           â•‘"
    echo "â•‘               ç‰ˆæœ¬: ${{ needs.build-check.outputs.build_version }}              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

# æ£€æŸ¥ç³»ç»Ÿ
check_system() {
    log "æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."
    
    # æ£€æŸ¥æ¶æ„
    local arch=$(uname -m)
    case "$arch" in
        armv7l|armhf)
            success "æ£€æµ‹åˆ° ARMv7 æ¶æ„ ($arch)"
            ;;
        *)
            warn "æ£€æµ‹åˆ°æ¶æ„: $arch (é¢„æœŸ: ARMv7)"
            read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ[y/N]: " -n 1 -r
            echo
            [[ $REPLY =~ ^[Yy]$ ]] || error "å®‰è£…ä¸­æ­¢"
            ;;
    esac
    
    # æ£€æŸ¥å†…å­˜
    local mem=$(free -m | awk '/^Mem:/{print $2}')
    if [ "$mem" -lt 128 ]; then
        warn "ç³»ç»Ÿå†…å­˜è¾ƒä½ ($mem MB)ï¼Œå»ºè®®è‡³å°‘æœ‰ 256MB å†…å­˜"
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk=$(df -m / | awk 'NR==2 {print $4}')
    if [ "$disk" -lt 50 ]; then
        warn "ç£ç›˜ç©ºé—´ç´§å¼  ($disk MB å¯ç”¨)"
    fi
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    log "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    local deps_missing=false
    
    # æ£€æŸ¥å¿…éœ€çš„å‘½ä»¤
    for cmd in curl systemctl ip; do
        if ! command -v "$cmd" &> /dev/null; then
            warn "ç¼ºå°‘å‘½ä»¤: $cmd"
            deps_missing=true
        fi
    done
    
    if [ "$deps_missing" = true ]; then
        log "å°è¯•å®‰è£…ä¾èµ–..."
        
        if command -v apt-get &> /dev/null; then
            apt-get update
            apt-get install -y curl iproute2 ca-certificates || warn "éƒ¨åˆ†ä¾èµ–å®‰è£…å¤±è´¥"
        elif command -v yum &> /dev/null; then
            yum install -y curl iproute ca-certificates || warn "éƒ¨åˆ†ä¾èµ–å®‰è£…å¤±è´¥"
        elif command -v opkg &> /dev/null; then
            opkg update
            opkg install curl ca-certificates || warn "éƒ¨åˆ†ä¾èµ–å®‰è£…å¤±è´¥"
        else
            warn "æ— æ³•è‡ªåŠ¨å®‰è£…ä¾èµ–ï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
        fi
    fi
}

# å®‰è£…ä¸»ç¨‹åº
install_binary() {
    log "å®‰è£… ech-workers ä¸»ç¨‹åº..."
    
    # åˆ›å»ºå®‰è£…ç›®å½•
    mkdir -p "$INSTALL_DIR"
    
    # å¤‡ä»½æ—§ç‰ˆæœ¬
    local binary_path="$INSTALL_DIR/ech-workers"
    if [ -f "$binary_path" ]; then
        local backup_path="${binary_path}.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$binary_path" "$backup_path"
        success "æ—§ç‰ˆæœ¬å·²å¤‡ä»½åˆ°: $backup_path"
    fi
    
    # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
    local binary_source
    for file in ech-workers-*; do
        if [[ "$file" == ech-workers-* && ! "$file" == *.* ]]; then
            binary_source="$file"
            break
        fi
    done
    
    if [ -z "$binary_source" ]; then
        error "æ‰¾ä¸åˆ°å¯å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶"
    fi
    
    # å®‰è£…æ–°ç‰ˆæœ¬
    cp "$binary_source" "$binary_path"
    chmod +x "$binary_path"
    chown root:root "$binary_path"
    
    # éªŒè¯å®‰è£…
    if [ -x "$binary_path" ]; then
        local version_info=$("$binary_path" --help 2>&1 | head -5)
        success "ç¨‹åºå®‰è£…æˆåŠŸ"
        echo "ç‰ˆæœ¬ä¿¡æ¯:"
        echo "$version_info" | sed 's/^/  /'
    else
        error "ç¨‹åºå®‰è£…å¤±è´¥"
    fi
}

# åˆ›å»ºé…ç½®æ–‡ä»¶
create_config() {
    log "åˆ›å»ºé…ç½®æ–‡ä»¶..."
    
    mkdir -p "$CONFIG_DIR"
    
    # ä¸»é…ç½®æ–‡ä»¶
    cat > "$CONFIG_DIR/config.env" << 'CONFIGEOF'
# ech-workers é…ç½®æ–‡ä»¶
# ç”Ÿæˆæ—¶é—´: $(date)

# åŸºæœ¬é…ç½®
LISTEN_ADDR="0.0.0.0:30000"
WORKER_URL="your-worker.workers.dev:443"
TOKEN="your_token_here"

# é«˜çº§é…ç½® (å¯é€‰)
# FALLBACK_PROXY=""
# PREFERRED_IP=""
# DNS_SERVER="223.5.5.5/dns-query"
# ECH_DOMAIN="cloudflare.ech.com"

# æ€§èƒ½è°ƒæ•´
# CONNECTION_LIMIT=100
# TIMEOUT=30
# BUFFER_SIZE=4096
CONFIGEOF
    
    # åˆ›å»ºç¤ºä¾‹å¯åŠ¨è„šæœ¬
    cat > "$CONFIG_DIR/start-example.sh" << 'EXAMPLEEOF'
#!/bin/bash
# ech-workers å¯åŠ¨ç¤ºä¾‹

source /etc/ech-workers/config.env

# æ„å»ºå‘½ä»¤è¡Œå‚æ•°
ARGS="-l \"\$LISTEN_ADDR\" -f \"\$WORKER_URL\" -token \"\$TOKEN\""

[ -n "\$FALLBACK_PROXY" ] && ARGS="\$ARGS -pyip \"\$FALLBACK_PROXY\""
[ -n "\$PREFERRED_IP" ] && ARGS="\$ARGS -ip \"\$PREFERRED_IP\""
[ -n "\$DNS_SERVER" ] && ARGS="\$ARGS -dns \"\$DNS_SERVER\""
[ -n "\$ECH_DOMAIN" ] && ARGS="\$ARGS -ech \"\$ECH_DOMAIN\""

echo "å¯åŠ¨å‘½ä»¤:"
echo "/usr/local/bin/ech-workers \$ARGS"

# å®é™…æ‰§è¡Œï¼ˆå–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ï¼‰
# exec /usr/local/bin/ech-workers \$ARGS
EXAMPLEEOF
    
    chmod +x "$CONFIG_DIR/start-example.sh"
    chmod 600 "$CONFIG_DIR/config.env"
    
    success "é…ç½®æ–‡ä»¶å·²åˆ›å»º: $CONFIG_DIR/"
}

# åˆ›å»º systemd æœåŠ¡
create_systemd_service() {
    log "åˆ›å»º systemd æœåŠ¡..."
    
    local service_file="$SERVICE_DIR/ech-workers.service"
    
    cat > "$service_file" << SERVICEEOF
[Unit]
Description=ech-workers Proxy Service (Hi3798MV100)
Description=åŸºäº Cloudflare Workers çš„ä»£ç†æœåŠ¡
After=network.target network-online.target
Wants=network-online.target
Documentation=https://github.com/${{ github.repository }}
Before=syslog.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/tmp

# ä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°
EnvironmentFile=-/etc/ech-workers/config.env

# å¯åŠ¨å‘½ä»¤
ExecStart=/usr/local/bin/ech-workers \\
    -l \${LISTEN_ADDR:-0.0.0.0:30000} \\
    -f \${WORKER_URL} \\
    -token \${TOKEN} \\
    \${FALLBACK_PROXY:+-pyip "\${FALLBACK_PROXY}"} \\
    \${PREFERRED_IP:+-ip "\${PREFERRED_IP}"} \\
    \${DNS_SERVER:+-dns "\${DNS_SERVER}"} \\
    \${ECH_DOMAIN:+-ech "\${ECH_DOMAIN}"}

# é‡å¯ç­–ç•¥
Restart=on-failure
RestartSec=10
RestartPreventExitStatus=0
StartLimitInterval=60
StartLimitBurst=3

# èµ„æºé™åˆ¶
LimitNOFILE=65536
MemoryMax=256M
MemoryHigh=200M
CPUQuota=80%

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
PrivateTmp=true
PrivateDevices=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
RestrictAddressFamilies=AF_INET AF_INET6
RestrictNamespaces=true
RestrictRealtime=true
SystemCallArchitectures=native
SystemCallFilter=@system-service

# æ—¥å¿—è®¾ç½®
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ech-workers
LogLevelMax=info

# ç¯å¢ƒå˜é‡
Environment="GODEBUG=netdns=go"
Environment="TZ=Asia/Shanghai"

[Install]
WantedBy=multi-user.target
SERVICEEOF
    
    # é‡æ–°åŠ è½½ systemd
    systemctl daemon-reload
    
    success "systemd æœåŠ¡æ–‡ä»¶å·²åˆ›å»º: $service_file"
}

# è®¾ç½®æ—¥å¿—è½®è½¬
setup_logrotate() {
    log "è®¾ç½®æ—¥å¿—è½®è½¬..."
    
    cat > /etc/logrotate.d/ech-workers << 'LOGROTATE'
/var/log/ech-workers/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        systemctl try-reload-or-restart ech-workers >/dev/null 2>&1 || true
    endscript
}
LOGROTATE
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p "$LOG_DIR"
    chmod 750 "$LOG_DIR"
    
    success "æ—¥å¿—è½®è½¬é…ç½®å®Œæˆ"
}

# é˜²ç«å¢™é…ç½®
configure_firewall() {
    log "é…ç½®é˜²ç«å¢™..."
    
    local port=${LISTEN_ADDR##*:}
    
    if command -v ufw &> /dev/null; then
        ufw allow "$port/tcp"
        ufw reload
        success "UFW é˜²ç«å¢™å·²é…ç½® (ç«¯å£: $port)"
    elif command -v iptables &> /dev/null; then
        iptables -A INPUT -p tcp --dport "$port" -j ACCEPT
        success "iptables è§„åˆ™å·²æ·»åŠ  (ç«¯å£: $port)"
    elif command -v firewall-cmd &> /dev/null; then
        firewall-cmd --permanent --add-port="$port/tcp"
        firewall-cmd --reload
        success "firewalld å·²é…ç½® (ç«¯å£: $port)"
    else
        warn "æœªæ‰¾åˆ°æ”¯æŒçš„é˜²ç«å¢™å·¥å…·ï¼Œè¯·æ‰‹åŠ¨å¼€æ”¾ç«¯å£ $port"
    fi
}

# åˆ›å»ºç®¡ç†è„šæœ¬
create_management_scripts() {
    log "åˆ›å»ºç®¡ç†è„šæœ¬..."
    
    # çŠ¶æ€æ£€æŸ¥è„šæœ¬
    cat > "/usr/local/bin/ech-workers-status" << 'STATUSEOF'
#!/bin/bash
# ech-workers çŠ¶æ€æ£€æŸ¥è„šæœ¬

SERVICE="ech-workers"
PORT=$(grep -oP 'LISTEN_ADDR=".*:\K\d+' /etc/ech-workers/config.env 2>/dev/null || echo "30000")

echo "ğŸ” ech-workers çŠ¶æ€æ£€æŸ¥"
echo "========================"

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if systemctl is-active --quiet "$SERVICE"; then
    echo "âœ… æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­"
    echo "   PID: $(systemctl show -p MainPID "$SERVICE" | cut -d= -f2)"
else
    echo "âŒ æœåŠ¡çŠ¶æ€: æœªè¿è¡Œ"
fi

# æ£€æŸ¥ç«¯å£ç›‘å¬
if ss -tln | grep -q ":$PORT "; then
    echo "âœ… ç«¯å£ç›‘å¬: æ­£å¸¸ (ç«¯å£: $PORT)"
else
    echo "âŒ ç«¯å£ç›‘å¬: å¼‚å¸¸"
fi

# æ£€æŸ¥é…ç½®æ–‡ä»¶
if [ -f "/etc/ech-workers/config.env" ]; then
    echo "âœ… é…ç½®æ–‡ä»¶: å­˜åœ¨"
else
    echo "âš ï¸ é…ç½®æ–‡ä»¶: ç¼ºå¤±"
fi

# æµ‹è¯•è¿æ¥ï¼ˆå¯é€‰ï¼‰
if [ "$1" == "--test" ]; then
    echo -n "æµ‹è¯•ä»£ç†è¿æ¥: "
    if timeout 5 curl -s --proxy "http://127.0.0.1:$PORT" http://httpbin.org/ip >/dev/null; then
        echo "âœ… æˆåŠŸ"
    else
        echo "âŒ å¤±è´¥"
    fi
fi
STATUSEOF
    
    chmod +x "/usr/local/bin/ech-workers-status"
    
    success "ç®¡ç†è„šæœ¬å·²åˆ›å»º"
}

# æ˜¾ç¤ºå®‰è£…å®Œæˆä¿¡æ¯
show_completion() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                   å®‰è£…å®Œæˆï¼                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ“‹ å®‰è£…æ‘˜è¦:"
    echo "  â€¢ ç¨‹åºæ–‡ä»¶: $INSTALL_DIR/ech-workers"
    echo "  â€¢ é…ç½®æ–‡ä»¶: $CONFIG_DIR/"
    echo "  â€¢ æœåŠ¡æ–‡ä»¶: $SERVICE_DIR/ech-workers.service"
    echo "  â€¢ æ—¥å¿—ç›®å½•: $LOG_DIR/"
    echo ""
    echo "ğŸš€ å¯åŠ¨æœåŠ¡:"
    echo "  sudo systemctl start ech-workers"
    echo ""
    echo "ğŸ“Š æœåŠ¡ç®¡ç†:"
    echo "  sudo systemctl status ech-workers    # æŸ¥çœ‹çŠ¶æ€"
    echo "  sudo systemctl restart ech-workers   # é‡å¯æœåŠ¡"
    echo "  sudo journalctl -u ech-workers -f    # æŸ¥çœ‹æ—¥å¿—"
    echo ""
    echo "ğŸ”§ é…ç½®ä¿®æ”¹:"
    echo "  ç¼–è¾‘é…ç½®æ–‡ä»¶: sudo nano /etc/ech-workers/config.env"
    echo "  ç„¶åé‡å¯: sudo systemctl restart ech-workers"
    echo ""
    echo "ğŸŒ ä»£ç†åœ°å€:"
    echo "  HTTP/HTTPS: http://$(hostname -I | awk '{print $1}'):${LISTEN_ADDR##*:}"
    echo "  SOCKS5: socks5://$(hostname -I | awk '{print $1}'):${LISTEN_ADDR##*:}"
    echo ""
    echo "ğŸ’¡ å¿«é€Ÿæµ‹è¯•:"
    echo "  curl --proxy http://127.0.0.1:${LISTEN_ADDR##*:} http://httpbin.org/ip"
    echo ""
    echo "ğŸ“ ç‰ˆæœ¬ä¿¡æ¯:"
    /usr/local/bin/ech-workers --help 2>&1 | grep -E "(ç‰ˆæœ¬|Version)" | head -2 || true
}

# ä¸»å®‰è£…æµç¨‹
main() {
    show_banner
    check_system
    install_dependencies
    install_binary
    create_config
    create_systemd_service
    setup_logrotate
    configure_firewall
    create_management_scripts
    show_completion
    
    log "å®‰è£…å®Œæˆï¼å»ºè®®é‡å¯æœåŠ¡ä½¿æ‰€æœ‰é…ç½®ç”Ÿæ•ˆã€‚"
    echo ""
    read -p "æ˜¯å¦ç«‹å³å¯åŠ¨æœåŠ¡ï¼Ÿ[Y/n]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]] || [ -z "$REPLY" ]; then
        systemctl start ech-workers
        systemctl enable ech-workers
        success "æœåŠ¡å·²å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯"
    fi
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
EOF
          
          chmod +x "$PACKAGE_DIR/install.sh"
          
          # åˆ›å»º tar åŒ…
          tar -czf "${PACKAGE_DIR}.tar.gz" "$PACKAGE_DIR"
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$PACKAGE_DIR"
          
          echo "âœ… æ‰“åŒ…å®Œæˆ: ${PACKAGE_DIR}.tar.gz"
      
      - name: ğŸ·ï¸ é‡å‘½åæ–‡ä»¶
        run: |
          cd ${{ env.OUTPUT_DIR }}
          
          VERSION="${{ needs.build-check.outputs.build_version }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          
          # é‡å‘½åä¸»è¦æ–‡ä»¶
          for ext in "" .sha256 .sha1 .md5 .b3sum; do
            if [ -f "${{ env.PROJECT_NAME }}-armv7${steps.build.outputs.build_suffix}${ext}" ]; then
              mv "${{ env.PROJECT_NAME }}-armv7${steps.build.outputs.build_suffix}${ext}" \
                 "${{ env.PROJECT_NAME }}-${VERSION}-armv7${BUILD_TYPE}${ext}"
            fi
          done
          
          echo "ğŸ“ æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨:"
          ls -lh *
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-${{ needs.build-check.outputs.build_version }}-${{ matrix.build_type }}
          path: ${{ env.OUTPUT_DIR }}/*
          retention-days: 30
          if-no-files-found: error
  
  create-release:
    runs-on: ubuntu-latest
    needs: [build-check, build-armv7]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: ${{ env.PROJECT_NAME }}-*
          merge-multiple: true
      
      - name: ğŸ·ï¸ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ needs.build-check.outputs.build_version }}
          body: |
            # ech-workers Hi3798MV100 ARMv7 ç‰ˆæœ¬
            
            ## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ needs.build-check.outputs.build_version }}
            - **æ„å»ºæ—¶é—´**: ${{ env.BUILD_DATE }}
            - **ç›®æ ‡è®¾å¤‡**: Hi3798MV100 (ARMv7)
            - **Goç‰ˆæœ¬**: ${{ env.GO_VERSION }}
            
            ## ğŸ“¦ åŒ…å«çš„æ„å»º
            - **æ ‡å‡†ç‰ˆæœ¬**: åŠ¨æ€é“¾æ¥åº“ï¼Œä½“ç§¯è¾ƒå°
            - **é™æ€ç‰ˆæœ¬**: å®Œå…¨é™æ€ç¼–è¯‘ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–
            
            ## ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”çš„ tar.gz æ–‡ä»¶
            2. è§£å‹: `tar -xzf ech-workers-*.tar.gz`
            3. è¿è¡Œå®‰è£…è„šæœ¬: `sudo ./install.sh`
            
            ## ğŸ”§ ä½¿ç”¨è¯´æ˜
            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒè§£å‹åçš„ README æ–‡ä»¶
            
            ## ğŸ“ å˜æ›´æ—¥å¿—
            ${{ github.event.head_commit.message }}
            
            ## ğŸ”’ æ ¡éªŒå’Œ
            ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶æ ¡éªŒå’Œç¡®ä¿å®Œæ•´æ€§
          draft: false
          prerelease: false
          files: |
            artifacts/*.tar.gz
            artifacts/*.sha256
            artifacts/*.md5
            artifacts/BUILD_INFO.txt
      
      - name: ğŸ“¢ å‘å¸ƒé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ needs.build-check.outputs.build_version }}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build-check.outputs.build_version }}"

  cleanup:
    runs-on: ubuntu-latest
    needs: [build-armv7, create-release]
    if: always()
    
    steps:
      - name: ğŸ§¹ æ¸…ç†å·¥ä½œæµ
        run: |
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜..."
          if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
            echo "æ¸…ç†æ‰€æœ‰ç¼“å­˜"
            # è¿™é‡Œå¯ä»¥æ·»åŠ ç¼“å­˜æ¸…ç†é€»è¾‘
          fi
          
          echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "çŠ¶æ€: ${{ job.status }}"
