#!/bin/bash
set -e

# 设置工具链路径
setup_toolchain() {
    echo "设置交叉编译工具链..."
    
    # 方法1: 检查是否已安装
    if command -v arm-linux-musleabihf-gcc >/dev/null 2>&1; then
        echo "使用现有的 arm-linux-musleabihf-gcc"
        return 0
    fi
    
    # 方法2: 使用 musl.cc
    local musl_url="https://musl.cc/arm-linux-musleabihf-cross.tgz"
    local toolchain_dir="/tmp/arm-musl-toolchain"
    
    echo "下载 musl 工具链..."
    mkdir -p "$toolchain_dir"
    wget -q "$musl_url" -O /tmp/arm-musl.tgz
    tar -xzf /tmp/arm-musl.tgz -C "$toolchain_dir" --strip-components=1
    
    # 添加到 PATH
    export PATH="$toolchain_dir/bin:$PATH"
    
    # 验证
    if command -v arm-linux-musleabihf-gcc >/dev/null 2>&1; then
        echo "工具链安装成功"
        return 0
    else
        echo "警告: 工具链安装失败，将使用纯 Go 编译"
        return 1
    fi
}

# 主要构建函数
build_for_armv7() {
    local version="$1"
    local use_cgo="$2"
    
    echo "为 ARMv7 构建..."
    
    export GOOS=linux
    export GOARCH=arm
    export GOARM=7
    
    if [ "$use_cgo" = "1" ] && setup_toolchain; then
        echo "使用 CGO 静态编译..."
        export CC="arm-linux-musleabihf-gcc"
        export CGO_ENABLED=1
        
        go build -a \
            -o "ech-workers-armv7-static" \
            -ldflags="-w -s -linkmode external -extldflags '-static' -X 'main.version=$version'" \
            .
    else
        echo "使用纯 Go 编译..."
        export CGO_ENABLED=0
        
        go build \
            -o "ech-workers-armv7-purego" \
            -ldflags="-w -s -X 'main.version=$version'" \
            .
    fi
}

# 主流程
main() {
    VERSION="${1:-$(git describe --tags 2>/dev/null || echo "v1.0.0")}"
    
    echo "构建版本: $VERSION"
    echo "系统: $(uname -s) $(uname -m)"
    echo "Go: $(go version)"
    
    # 清理
    rm -f ech-workers-*
    
    # 构建
    build_for_armv7 "$VERSION" "1"  # 尝试静态编译
    build_for_armv7 "$VERSION" "0"  # 纯 Go 版本
    
    # 验证
    echo "构建结果:"
    ls -lh ech-workers-*
    for bin in ech-workers-*; do
        if [ -f "$bin" ]; then
            echo "  $bin: $(file "$bin")"
        fi
    done
}

# 执行
main "$@"
