name: Build ech-workers for Hi3798MV100

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 手动触发

jobs:
  build-hi3798mv100:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        target:
          - name: "linux-armv7-musl"
            GOOS: "linux"
            GOARCH: "arm"
            GOARM: "7"
            CC: "arm-linux-musleabihf-gcc"
            CGO_ENABLED: "1"
            output: "ech-workers-linux-armv7-musl"
            flags: "-w -s -linkmode external -extldflags '-static'"
          
          - name: "linux-armv7-purego"
            GOOS: "linux"
            GOARCH: "arm"
            GOARM: "7"
            CGO_ENABLED: "0"
            output: "ech-workers-linux-armv7-purego"
            flags: "-w -s"
          
          - name: "linux-armv6"
            GOOS: "linux"
            GOARCH: "arm"
            GOARM: "6"
            CGO_ENABLED: "0"
            output: "ech-workers-linux-armv6"
            flags: "-w -s"
          
          - name: "linux-arm64"
            GOOS: "linux"
            GOARCH: "arm64"
            CGO_ENABLED: "0"
            output: "ech-workers-linux-arm64"
            flags: "-w -s"
          
          - name: "linux-amd64"
            GOOS: "linux"
            GOARCH: "amd64"
            CGO_ENABLED: "0"
            output: "ech-workers-linux-amd64"
            flags: "-w -s"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-arm-linux-gnueabihf \
          gcc-aarch64-linux-gnu \
          musl-tools \
          binutils-aarch64-linux-gnu \
          binutils-arm-linux-gnueabihf
        
        # 安装 musl 交叉编译器
        wget https://musl.cc/arm-linux-musleabihf-cross.tgz
        sudo tar -xzf arm-linux-musleabihf-cross.tgz -C /usr/local --strip-components=1
        echo "/usr/local/bin" >> $GITHUB_PATH
        
        wget https://musl.cc/aarch64-linux-musl-cross.tgz
        sudo tar -xzf aarch64-linux-musl-cross.tgz -C /usr/local --strip-components=1
    
    - name: Build
      run: |
        echo "Building ${{ matrix.target.name }}"
        
        # 设置环境变量
        export GOOS=${{ matrix.target.GOOS }}
        export GOARCH=${{ matrix.target.GOARCH }}
        export GOARM=${{ matrix.target.GOARM }}
        export CGO_ENABLED=${{ matrix.target.CGO_ENABLED }}
        
        if [ "${{ matrix.target.CC }}" != "null" ]; then
          export CC=${{ matrix.target.CC }}
        fi
        
        # 获取版本信息
        VERSION=$(git describe --tags 2>/dev/null || echo "v0.0.0")
        COMMIT=$(git rev-parse --short HEAD)
        DATE=$(date -u '+%Y-%m-%d_%H:%M:%S')
        
        # 编译
        go build \
          -o "build/${{ matrix.target.output }}" \
          -ldflags="${{ matrix.target.flags }} -X 'main.version=$VERSION' -X 'main.commit=$COMMIT' -X 'main.date=$DATE'" \
          .
    
    - name: Verify binary
      run: |
        echo "Verifying ${{ matrix.target.output }}"
        file "build/${{ matrix.target.output }}"
        ls -lh "build/${{ matrix.target.output }}"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.target.name }}
        path: build/${{ matrix.target.output }}
        retention-days: 7
  
  # 专门为 Hi3798MV100 优化的构建
  build-hi3798-special:
    runs-on: ubuntu-latest
    needs: build-hi3798mv100
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Build for Hi3798MV100 (static musl)
      run: |
        # 安装 musl 工具链
        wget https://musl.cc/arm-linux-musleabihf-cross.tgz
        tar -xzf arm-linux-musleabihf-cross.tgz
        
        # 设置环境
        export PATH="$PWD/arm-linux-musleabihf-cross/bin:$PATH"
        export CC="arm-linux-musleabihf-gcc"
        export GOOS=linux
        export GOARCH=arm
        export GOARM=7
        export CGO_ENABLED=1
        
        # 版本信息
        VERSION="1.0.0-hi3798mv100-$(date +%Y%m%d)"
        
        # 静态编译
        go build -a \
          -o "ech-workers-hi3798mv100-static" \
          -ldflags="-w -s -linkmode external -extldflags '-static' -X 'main.version=$VERSION'" \
          .
        
        # 创建纯 Go 版本（备用）
        CGO_ENABLED=0 go build \
          -o "ech-workers-hi3798mv100-purego" \
          -ldflags="-w -s -X 'main.version=$VERSION'" \
          .
    
    - name: Create release package
      run: |
        mkdir -p release
        mv ech-workers-hi3798mv100-* release/
        
        # 创建说明文件
        cat > release/README.md << 'EOF'
        # ech-workers for Hi3798MV100
        
        版本: $(date +%Y%m%d)
        设备: Hi3798MV100 (ARMv7)
        
        包含两个版本:
        1. ech-workers-hi3798mv100-static - 静态链接版本
        2. ech-workers-hi3798mv100-purego - 纯 Go 版本
        
        使用方法:
        ```bash
        # 设置权限
        chmod +x ech-workers-hi3798mv100-static
        
        # 运行
        ./ech-workers-hi3798mv100-static \
          -l 0.0.0.0:30000 \
          -f your-worker.workers.dev:443 \
          -token YOUR_TOKEN \
          -pyip backup.proxy.com:8080 \
          -ip 104.16.132.229
        ```
        EOF
        
        # 创建压缩包
        tar -czf ech-workers-hi3798mv100.tar.gz -C release .
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hi3798mv100-release
        path: |
          ech-workers-hi3798mv100.tar.gz
          release/
        retention-days: 30
  
  # 创建 GitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [build-hi3798mv100, build-hi3798-special]
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: List artifacts
      run: find artifacts -type f
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/**/*
    
    - name: Output release URL
      run: echo "Release created at ${{ steps.create_release.outputs.url }}"
